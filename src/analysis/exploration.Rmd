---
title: "R Notebook: initial exploration for Gas Cost Estimator"
output: html_notebook
---

```{r fig.width=20}
library(sqldf)
```

Read in the `programs.csv` as generated by `src/program_generator.py` with `--fullCSV` flag on
```{r fig.width=20}
setwd("~/sources/imapp/gas-cost-estimator/src")
programs = read.csv("../../programs.csv")
head(programs)
```

Modify `programs.csv` to adjust for the fact, that `evmone` prepends a `JUMPDEST` instruction at the vary beginning of each bytecode:
(**TODO** track and adjust for the programs instructions more elegantly)

```{r fig.width=20}
programs$measured_op_position_evmone = programs$measured_op_position + 1
head(programs)
```

Read in the `result_geth.csv` and `result_evmone.csv` as generated by `src/measurements.py`

```{r fig.width=20}
setwd("~/sources/imapp/gas-cost-estimator/src")
result_geth = read.csv("../../result_geth.csv")
result_evmone = read.csv("../../result_evmone.csv")
result_geth$env = "geth"
result_evmone$env = "evmone"
results = rbind(result_geth, result_evmone)
head(results)
```

Combine the two tables to see only times of the measured opcodes.

```{r fig.width=20}
measurements = sqldf("SELECT opcode_measured, sample_id, run_id, measure_all_time_ns, env
                     FROM results
                     INNER JOIN 
                       programs ON(results.program_id = programs.program_id)
                     WHERE 
                       (results.instruction_id = programs.measured_op_position AND results.env = 'geth') OR
                       (results.instruction_id = programs.measured_op_position_evmone AND results.env = 'evmone')
                     ")

head(measurements)
                     
```

Quick overview of times everything and by env:

```{r fig.width=20}
summary(measurements$measure_all_time_ns)

tapply(measurements$measure_all_time_ns, measurements$env, summary)
```

Quick overview of measurements per opcode:
```{r fig.width=20}
print("Geth")
measurements_geth = measurements[which(measurements$env=="geth"), ]
tapply(measurements_geth$measure_all_time_ns, measurements_geth$opcode_measured, summary)
print("Evmone")
measurements_evmone = measurements[which(measurements$env=="evmone"), ]
tapply(measurements_evmone$measure_all_time_ns, measurements_evmone$opcode_measured, summary)
```

```{r fig.width=20}
boxplot(measure_all_time_ns ~ opcode_measured, data=measurements_geth, las=2)
boxplot(measure_all_time_ns ~ opcode_measured, data=measurements_evmone, las=2)
```

Quick check that `sample_id` shouldn't impact measurements:

```{r fig.width=20}
boxplot(measure_all_time_ns ~ sample_id, data=measurements, las=2)
```

But `run_id` does impact measurements: first several runs have a decreasing trend. **TODO** needs investigation how/if to alleviate:

```{r fig.width=20}
boxplot(measure_all_time_ns ~ run_id, data=measurements, las=2)
```