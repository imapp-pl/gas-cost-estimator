---
title: "R Notebook: exploration of validation by comparing individual and total measurements; for Gas Cost Estimator"
output: html_notebook
---

```{r include=FALSE, fig.width=20}
library(sqldf)
```

## Data preparations

Read in the `programs.csv` as generated by `src/program_generator.py` with `--fullCSV` flag on.

We're using the random arithmetic program generator via: `python3 program_generator/pg_arythmetic.py generate --count=10 --opsLimit=10 --fullCsv > ../../local/pg_arythmetic_10_10.csv`.

Then tracing it using: `docker run   --rm -v /home/user/sources/imapp/local:/srv/local  -it gas-cost-estimator/geth_all sh -c "cd src && cat /srv/local/pg_arythmetic_10_10.csv | python3 instrumentation_measurement/measurements.py measure --evm geth --mode trace --sampleSize 1 > /srv/local/trace_pg_arythmetic_10_10.csv"`.

```{r fig.width=20}
setwd("~/sources/imapp/gas-cost-estimator/src")
programs = read.csv("../../local/pg_arythmetic_c100_ops10.csv")
traces = read.csv("../../local/trace_pg_arythmetic_c100_ops10.csv")
head(traces)
```

```{r}
setwd("~/sources/imapp/gas-cost-estimator/src")
total_measurements = read.csv("../../local/geth_pg_arythmetic_c100_ops10.csv")
head(total_measurements)
```

```{r}
# temporary workaround for obtaining the estimated cost weights
setwd("~/sources/imapp/gas-cost-estimator/src")
estimated_cost = read.csv("../../local/rough_opcode_costs_new.csv")
head(estimated_cost)
```

```{r}
ops_per_program = data.frame(table(traces$program_id, traces$op, dnn=c("program_id", "op")))

estimated_programs = sqldf("SELECT program_id, sum(ops_per_program.Freq * estimated_cost.min) as cost
                           FROM ops_per_program
                           INNER JOIN estimated_cost ON ops_per_program.op == estimated_cost.op
                           GROUP BY program_id")

validation = sqldf("SELECT
                      estimated_programs.program_id,
                      avg(total_measurements.measure_total_time_ns) as avg_measure_total_time_ns,
                      cost
                    FROM estimated_programs
                    INNER JOIN total_measurements ON total_measurements.program_id == estimated_programs.program_id
                    GROUP BY estimated_programs.program_id")

head(validation)
```

Basic inspection of data reveals strong decreasing trend for each sample (sequence of runs) and a lot of outliers.

```{r}
plot(total_measurements$measure_total_time_ns, ylim=c(0,3200))
boxplot(total_measurements$measure_total_time_ns)
boxplot(measure_total_time_ns ~ program_id, data=total_measurements, outline=FALSE)
# tapply(total_measurements$measure_total_time_ns, total_measurements$program_id, hist, probability=T)
# tapply(total_measurements$measure_total_time_ns, total_measurements$program_id, summary)
```
```{r}
scatter.smooth(validation$cost, validation$avg_measure_total_time_ns, col='red')
summary(lm(avg_measure_total_time_ns ~ cost, data=validation))
```
